name: CI/CD to Compute Engine VM

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Obtener el repo
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}


      - name: Create .env file
        run: |
          echo "RESEND_API_KEY=${{ secrets.RESEND_API_KEY }}" >> .env
          echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> .env

      # 2. Python + tests
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run tests
        run: pytest -v

      # 3. Autenticaci√≥n con Google Cloud
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v3
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up gcloud CLI
        uses: google-github-actions/setup-gcloud@v2


      # 4. Deploy - entrar a la VM, git pull , reconstruir
      - name: Deploy to VM
        run: |
          gcloud compute ssh habits-vm --zone=europe-west1-b --command "
            whoami
            sudo chown -R whoami:whoami /opt/app &&
            cd /opt/app/FinalProjectInfrastructure &&
            git pull origin main &&
            sudo docker-compose down || true &&
            sudo docker-compose up -d --build --force-recreate
          "

